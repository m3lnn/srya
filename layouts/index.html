{{ define "page-head" }}
<link rel="stylesheet" href="/css/working.css"> {{ end }} {{ define "header-content" }}
<canvas class="pixel-canvas" id="pixelCanvas"></canvas>

<div class="heading-content" id="mainHeader">
    <div id="content">
        <span class="heading-quote" id="heading">{{ .Site.Params.tagline | default "Finding my place between beauty and practicality" }}</span>
        <p>{{ .Site.Params.subtitle | default "Software Designer | Creative Technologist" }}</p>
    </div>
</div>

{{ end }} {{ define "main" }}
<div>
    <h2>{{ .Site.Params.authorName | default "Shaurya singh" }}</h2>
    <p>{{ .Site.Params.currentRole | markdownify }}</p>
    <p>I design and build software, and tinker with physical products. I believe in technology as a tool to empower people. If you have an interesting idea, get in touch.</p>
</div>

<div>
    <div class="container">

        <div class="filter-section">
            <h1>work</h1>
            <span style="margin-bottom: 0;">I want to see</span>
            <div class="filter-buttons" id="filterButtons">
                <button class="filter-btn active" onclick="filterProjects('all')">everything</button>
                <!-- Dynamic filter buttons will be added here by JavaScript -->
            </div>
        </div>
    </div>

    <div>
        {{ $projects := where .Site.RegularPages "Section" "working" }} {{ $projects = sort $projects "Date" "desc" }} {{ $yearMap := dict }} {{ $years := slice }} {{ $allTags := slice }}

        <!-- Group projects by year and collect all tags -->
        {{ range $projects }} {{ $year := .Params.year }} {{ if $year }} {{ $yearStr := string $year }} {{ $existing := index $yearMap $yearStr }} {{ if $existing }} {{ $yearMap = merge $yearMap (dict $yearStr ($existing | append .)) }} {{ else }} {{ $yearMap
        = merge $yearMap (dict $yearStr (slice .)) }} {{ $years = $years | append $year }} {{ end }} {{ end }}

        <!-- Collect all tags -->
        {{ range .Params.tags }} {{ if not (in $allTags .) }} {{ $allTags = $allTags | append . }} {{ end }} {{ end }} {{ end }}

        <!-- Display projects grouped by year -->
        {{ range $year := sort $years "value" "desc" }} {{ $projectsInYear := index $yearMap (string $year) }} {{ $summary := index $.Site.Data.years (string $year) }}


        <div class="year-container">
            <div class="projects-year">
                <h2>{{ $year }}</h2> {{ with $summary }}
                <p>{{ . }}</p>
                {{ end }}
            </div>

            <div class="project-list">
                {{ range $projectsInYear }}
                <div class="project-card {{ range .Params.tags }}tag-{{ . | urlize }} {{ end }}" data-tags="{{ delimit .Params.tags " , " }}">
                    {{ if .Params.external }}
                    <a class="external" href="{{ .Params.externalurl }}" target="_blank" rel="noopener">
                            {{ else }}
                            <a href="{{ .RelPermalink }}">
                        {{ end }}
                        <div class="cover-media" data-cover-media>
                                {{ with .Resources.GetMatch .Params.cover }}
                                    <img src="{{ .RelPermalink }}" alt="" class="cover-image" data-cover-image>
                                {{ else }}
                                    <div class="cover-placeholder">
                                        <span class="cover-title">{{ .Title }}</span>
                                    </div>
                                {{ end }}
                            </div>
                            <div class="project-content" data-project-content>
                                <div>
                                    <h3>{{ .Title }}
                                            {{ if .Params.external }}
                                                ðŸ”—
                                            {{ end }}
                                        </h3>
                                    {{ with .Params.description }}
                                        <p class="project-description">{{ . }}</p>
                                    {{ end }}

                                </div>

                                    <div>
                                        {{ with .Params.tags }}
                                        <div class="project-tags">
                                            {{ range . }}
                                                <span class="tag-pill">{{ . }}</span>
                                            {{ end }}
                                        </div>
                                    {{ end }}
                                    </div>
                            </div>
                        </a>
                </div>
                {{ end }}

            </div>
        </div>
        {{ end }}

    </div>
</div>

<script>
    // All unique tags from Hugo
    const allTags = [{{ range $allTags }}"{{ . }}",{{ end }}];
    
    // Track active filters
    let activeFilters = new Set();
    
    // Create filter buttons dynamically
    const filterContainer = document.getElementById('filterButtons');
    allTags.forEach(tag => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.textContent = tag;
        btn.onclick = () => toggleFilter(tag);
        filterContainer.appendChild(btn);
    });

    // Show all projects initially
    filterProjects('all');

    function updateYearVisibility() {
        const yearContainers = document.getElementsByClassName('year-container');

        for (let i = 0; i < yearContainers.length; i++) {
            const container = yearContainers[i];
            const projects = container.querySelectorAll('.project-card');

            const anyVisible = Array.from(projects).some(p => p.classList.contains('show'));
            container.style.display = anyVisible ? '' : 'none';
        }
    }

    function filterProjects(filter) {
        const projects = document.getElementsByClassName('project-card');
        const buttons = document.getElementsByClassName('filter-btn');
        
        if (filter === 'all') {
            activeFilters.clear();

            for (let i = 0; i < projects.length; i++) {
                projects[i].classList.add('show');
            }

            for (let i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }

            buttons[0].classList.add('active');
            updateYearVisibility();
        }
    }

    function toggleFilter(tag) {
        const buttons = document.getElementsByClassName('filter-btn');

        // Toggle filter on/off
        if (activeFilters.has(tag)) {
            activeFilters.delete(tag);
        } else {
            activeFilters.add(tag);
        }

        // If no filters left â†’ show everything
        if (activeFilters.size === 0) {
            filterProjects('all');
            return;
        }

        // Deactivate "everything" button
        buttons[0].classList.remove('active');

        // Update individual button states
        for (let i = 1; i < buttons.length; i++) {
            const btnTag = buttons[i].textContent;
            buttons[i].classList.toggle('active', activeFilters.has(btnTag));
        }

        // Apply filtering
        const projects = document.getElementsByClassName('project-card');

        for (let i = 0; i < projects.length; i++) {
            const projectTags = projects[i]
                .getAttribute('data-tags')
                .split(',')
                .map(t => t.trim());

            const hasMatch = projectTags.some(t => activeFilters.has(t));

            projects[i].classList.toggle('show', hasMatch);
        }

        updateYearVisibility();
    }

    // Cursor-following cover image functionality
    document.addEventListener('DOMContentLoaded', function() {
        const projectContents = document.querySelectorAll('[data-project-content]');
        const coverMedias = document.querySelectorAll('[data-cover-media]');
        
        // Keep track of active cover image
        let activeCoverMedia = null;
        let activeCoverImage = null;
        
        // Create a floating image element
        const floatingImage = document.createElement('div');
        floatingImage.className = 'floating-cover-image';
        document.body.appendChild(floatingImage);
        
        projectContents.forEach((content, index) => {
            const coverMedia = coverMedias[index];
            const coverImage = coverMedia?.querySelector('[data-cover-image]');
            
            if (!coverImage) return; // Skip if no image
            
            content.addEventListener('mouseenter', function(e) {
                activeCoverMedia = coverMedia;
                activeCoverImage = coverImage;
                
                const imageSrc = coverImage.src;
                floatingImage.style.backgroundImage = `url('${imageSrc}')`;
                floatingImage.style.opacity = '1';
                floatingImage.style.pointerEvents = 'none';
                
                updateFloatingImagePosition(e);
            });
            
            content.addEventListener('mousemove', function(e) {
                if (activeCoverImage === coverImage) {
                    updateFloatingImagePosition(e);
                }
            });
            
            content.addEventListener('mouseleave', function() {
                floatingImage.style.opacity = '0';
                activeCoverMedia = null;
                activeCoverImage = null;
            });
        });
        
        function updateFloatingImagePosition(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            floatingImage.style.left = e.clientX + 'px';
            floatingImage.style.top = e.clientY + 'px';
            floatingImage.style.transform = 'translate(-50%, -50%)';
        }
    });
</script>

{{ end }}